<!DOCTYPE html>
<html lang="zh-CN" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>绳结管理 - 绳结教程管理系统</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        .sidebar {
            min-height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .sidebar .nav-link {
            color: rgba(255, 255, 255, 0.8);
            padding: 12px 20px;
            border-radius: 8px;
            margin: 2px 10px;
            transition: all 0.3s ease;
        }
        .sidebar .nav-link:hover,
        .sidebar .nav-link.active {
            color: white;
            background: rgba(255, 255, 255, 0.1);
        }
        .main-content {
            background: #f8f9fa;
            min-height: 100vh;
        }

        .card {
            border: none;
            box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
            border-radius: 0.5rem;
        }

        .btn-primary {
            background-color: #667eea;
            border-color: #667eea;
        }

        .btn-primary:hover {
            background-color: #5a6fd8;
            border-color: #5a6fd8;
        }

        .table th {
            border-top: none;
            font-weight: 600;
            color: #495057;
        }

        .badge {
            font-size: 0.75em;
        }

        .knot-image {
            width: 60px;
            height: 60px;
            object-fit: cover;
            border-radius: 8px;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <!-- 侧边栏 -->
            <nav class="col-md-3 col-lg-2 d-md-block sidebar collapse">
                <div class="position-sticky pt-3">
                    <div class="text-center mb-4">
                        <h4 class="text-white">绳结教程管理</h4>
                    </div>

                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link" th:href="@{/admin/dashboard}">
                                <i class="bi bi-speedometer2 me-2"></i>
                                仪表板
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link active" th:href="@{/admin/knots}">
                                <i class="bi bi-collection me-2"></i>
                                绳结管理
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" th:href="@{/admin/categories}">
                                <i class="bi bi-tags me-2"></i>
                                分类管理
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" th:href="@{/admin/users}">
                                <i class="bi bi-people me-2"></i>
                                用户管理
                            </a>
                        </li>
                        <li class="nav-item mt-4">
                            <a class="nav-link" th:href="@{/admin/logout}">
                                <i class="bi bi-box-arrow-right me-2"></i>
                                退出登录
                            </a>
                        </li>
                    </ul>
                </div>
            </nav>

            <!-- 主内容区 -->
            <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4 main-content">
                <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                    <h1 class="h2">绳结管理</h1>
                    <div class="d-flex align-items-center">
                        <div class="me-3">
                            <span class="text-muted">欢迎，</span>
                            <span class="fw-bold" th:text="${adminUser.username}">管理员</span>
                        </div>
                        <div class="btn-toolbar mb-2 mb-md-0">
                            <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addKnotModal">
                                <i class="bi bi-plus"></i> 添加绳结
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-danger ms-2" onclick="handleLogout()">
                                <i class="bi bi-box-arrow-right me-1"></i>退出登录
                            </button>
                        </div>
                    </div>
                </div>

                <!-- 搜索和筛选 -->
                <div class="row mb-3">
                    <div class="col-md-6">
                        <div class="input-group">
                            <input type="text" class="form-control" placeholder="搜索绳结名称..." id="searchInput">
                            <button class="btn btn-outline-secondary" type="button" id="searchBtn">
                                <i class="bi bi-search"></i>
                            </button>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <select class="form-select" id="categoryFilter">
                            <option value="">所有分类</option>
                            <option th:each="category : ${categories}" th:value="${category.id}" th:text="${category.name}"></option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <select class="form-select" id="statusFilter">
                            <option value="">所有状态</option>
                            <option value="true">已发布</option>
                            <option value="false">未发布</option>
                        </select>
                    </div>
                </div>

                <!-- 绳结列表 -->
                <div class="card">
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>封面</th>
                                        <th>名称</th>
                                        <th>分类</th>
                                        <th>难度</th>
                                        <th>浏览次数</th>
                                        <th>状态</th>
                                        <th>创建时间</th>
                                        <th>操作</th>
                                    </tr>
                                </thead>
                                <tbody id="knotsTableBody">
                                    <!-- 数据将通过JavaScript动态加载 -->
                                </tbody>
                            </table>
                        </div>

                        <!-- 分页控件 -->
                        <nav aria-label="绳结列表分页">
                            <ul class="pagination justify-content-center" id="pagination">
                                <!-- 分页将通过JavaScript动态生成 -->
                            </ul>
                        </nav>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- 添加绳结模态框 -->
    <div class="modal fade" id="addKnotModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">添加绳结</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="addKnotForm">
                        <div class="row">
                            <div class="col-md-8">
                                <div class="mb-3">
                                    <label for="knotName" class="form-label">绳结名称</label>
                                    <input type="text" class="form-control" id="knotName" required>
                                </div>
                                <div class="mb-3">
                                    <label for="knotDescription" class="form-label">描述</label>
                                    <textarea class="form-control" id="knotDescription" rows="3"></textarea>
                                </div>
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="knotCategory" class="form-label">分类</label>
                                            <select class="form-select" id="knotCategory" required>
                                                <option value="">选择分类</option>
                                                <option th:each="category : ${categories}" th:value="${category.id}" th:text="${category.name}"></option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="knotDifficulty" class="form-label">难度等级</label>
                                            <select class="form-select" id="knotDifficulty">
                                                <option value="1">1级 - 简单</option>
                                                <option value="2">2级 - 基础</option>
                                                <option value="3">3级 - 中等</option>
                                                <option value="4">4级 - 困难</option>
                                                <option value="5">5级 - 专家</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="knotCover" class="form-label">封面图片</label>
                                    <input type="file" class="form-control" id="knotCover" accept="image/*">
                                    <div class="mt-2">
                                        <img id="coverPreview" class="img-fluid d-none" style="max-width: 200px;">
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="knotPublished" checked>
                                        <label class="form-check-label" for="knotPublished">
                                            立即发布
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" onclick="saveKnot()">保存</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 编辑绳结模态框 -->
    <div class="modal fade" id="editKnotModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">编辑绳结</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="editKnotForm">
                        <input type="hidden" id="editKnotId">
                        <div class="row">
                            <div class="col-md-8">
                                <div class="mb-3">
                                    <label for="editKnotName" class="form-label">绳结名称</label>
                                    <input type="text" class="form-control" id="editKnotName" required>
                                </div>
                                <div class="mb-3">
                                    <label for="editKnotDescription" class="form-label">描述</label>
                                    <textarea class="form-control" id="editKnotDescription" rows="3"></textarea>
                                </div>
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="editKnotCategory" class="form-label">分类</label>
                                            <select class="form-select" id="editKnotCategory" required>
                                                <option value="">选择分类</option>
                                                <option th:each="category : ${categories}" th:value="${category.id}" th:text="${category.name}"></option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="editKnotDifficulty" class="form-label">难度等级</label>
                                            <select class="form-select" id="editKnotDifficulty">
                                                <option value="1">1级 - 简单</option>
                                                <option value="2">2级 - 基础</option>
                                                <option value="3">3级 - 中等</option>
                                                <option value="4">4级 - 困难</option>
                                                <option value="5">5级 - 专家</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="editKnotCover" class="form-label">封面图片</label>
                                    <input type="file" class="form-control" id="editKnotCover" accept="image/*">
                                    <div class="mt-2">
                                        <img id="editCoverPreview" class="img-fluid d-none" style="max-width: 200px;">
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="editKnotPublished">
                                        <label class="form-check-label" for="editKnotPublished">
                                            发布状态
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 现有图片管理 -->
                        <div class="mb-3">
                            <h6>现有图片管理</h6>
                            <div class="row" id="existingImagesContainer">
                                <!-- 现有图片将在这里动态显示 -->
                            </div>
                        </div>

                        <!-- 绳结步骤图片管理 -->
                        <div class="mb-3">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <h6>绳结步骤图片</h6>
                                <button type="button" class="btn btn-sm btn-primary" onclick="addKnotImageRow()">
                                    <i class="bi bi-plus"></i> 添加更多图片
                                </button>
                            </div>
                            <div id="knotImagesContainer">
                                <!-- 动态添加的图片行将在这里显示 -->
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" onclick="updateKnot()">保存</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let currentPage = 1;
        let currentSize = 10;
        let currentKeyword = '';
        let currentCategoryId = '';
        let currentStatus = '';

        // 页面加载时获取绳结列表
        document.addEventListener('DOMContentLoaded', function() {
            loadKnots();
        });

        // 加载绳结列表
        function loadKnots(page = 1) {
            currentPage = page;

            let url = `/admin/api/knots?page=${page}&pageSize=${currentSize}`;

            if (currentKeyword) {
                url += `&keyword=${encodeURIComponent(currentKeyword)}`;
            }
            if (currentCategoryId) {
                url += `&categoryId=${currentCategoryId}`;
            }
            if (currentStatus !== '') {
                url += `&isPublished=${currentStatus}`;
            }

            fetch(url)
                .then(response => response.json())
                .then(result => {
                    if (!result.success) {
                        alert(result.message || '获取绳结列表失败');
                        return;
                    }
                    displayKnots(result.data || []);
                    displayPagination({ page: (result.page || 1), totalCount: result.totalCount || 0 });
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('获取绳结列表失败，请重试');
                });
        }

        // 显示绳结列表
        function displayKnots(knots) {
            const tbody = document.getElementById('knotsTableBody');
            tbody.innerHTML = '';

            if (knots.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" class="text-center text-muted">暂无数据</td></tr>';
                return;
            }

            knots.forEach(knot => {
                const row = document.createElement('tr');

                // 生成难度星级
                let stars = '';
                for (let i = 1; i <= 5; i++) {
                    if (i <= knot.difficultyLevel) {
                        stars += '<i class="bi bi-star-fill text-warning"></i>';
                    } else {
                        stars += '<i class="bi bi-star text-muted"></i>';
                    }
                }

                // 生成封面图片
                let coverImage = '';
                if (knot.coverImage) {
                    coverImage = `<img src="${knot.coverImage}" class="knot-image" alt="封面">`;
                } else {
                    coverImage = '<div class="knot-image bg-light d-flex align-items-center justify-content-center"><i class="bi bi-image text-muted"></i></div>';
                }

                // 生成状态标签
                const statusBadge = knot.isPublished ?
                    '<span class="badge bg-success">已发布</span>' :
                    '<span class="badge bg-warning">未发布</span>';

                // 格式化创建时间
                const createdAt = knot.createdAt ? new Date(knot.createdAt).toLocaleString() : '-';

                row.innerHTML = `
                    <td>${knot.id}</td>
                    <td>${coverImage}</td>
                    <td>${knot.name}</td>
                    <td><span class="badge bg-primary">${knot.categoryName}</span></td>
                    <td>
                        <div class="d-flex align-items-center">
                            <div>${stars}</div>
                        </div>
                    </td>
                    <td>${knot.viewCount || 0}</td>
                    <td>${statusBadge}</td>
                    <td>${createdAt}</td>
                    <td>
                        <div class="btn-group" role="group">
                            <button type="button" class="btn btn-sm btn-outline-primary" onclick="editKnot(${knot.id})">
                                <i class="bi bi-pencil"></i>
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-danger" onclick="deleteKnot(${knot.id})">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // 显示分页控件
        function displayPagination(pageData) {
            const pagination = document.getElementById('pagination');
            pagination.innerHTML = '';

            const size = currentSize;
            const pageNumber = pageData.page || 1; // 1-based in this page
            const totalCount = pageData.totalCount || 0;
            const totalPages = Math.max(1, Math.ceil(totalCount / size));
            const hasPrevious = pageNumber > 1;
            const hasNext = pageNumber < totalPages;
            if (totalPages <= 1) { return; }

            // 上一页
            const prevLi = document.createElement('li');
            prevLi.className = `page-item ${hasPrevious ? '' : 'disabled'}`;
            prevLi.innerHTML = `<a class="page-link" href="#" onclick="loadKnots(${pageNumber - 1})">上一页</a>`;
            pagination.appendChild(prevLi);

            // 页码
            const startPage = Math.max(1, pageNumber - 2);
            const endPage = Math.min(totalPages, pageNumber + 2);

            for (let i = startPage; i <= endPage; i++) {
                const pageLi = document.createElement('li');
                pageLi.className = `page-item ${i === pageNumber ? 'active' : ''}`;
                pageLi.innerHTML = `<a class="page-link" href="#" onclick="loadKnots(${i})">${i}</a>`;
                pagination.appendChild(pageLi);
            }

            // 下一页
            const nextLi = document.createElement('li');
            nextLi.className = `page-item ${hasNext ? '' : 'disabled'}`;
            nextLi.innerHTML = `<a class="page-link" href="#" onclick="loadKnots(${pageNumber + 1})">下一页</a>`;
            pagination.appendChild(nextLi);
        }

        // 搜索功能
        document.getElementById('searchBtn').addEventListener('click', function() {
            currentKeyword = document.getElementById('searchInput').value.trim();
            loadKnots(1);
        });

        // 筛选功能
        document.getElementById('categoryFilter').addEventListener('change', function() {
            currentCategoryId = this.value;
            loadKnots(1);
        });

        document.getElementById('statusFilter').addEventListener('change', function() {
            currentStatus = this.value;
            loadKnots(1);
        });

        // 封面图片预览
        document.getElementById('knotCover').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const preview = document.getElementById('coverPreview');
                    preview.src = e.target.result;
                    preview.classList.remove('d-none');
                };
                reader.readAsDataURL(file);
            }
        });

        // 保存绳结
        function saveKnot() {
            // 获取表单数据
            const name = document.getElementById('knotName').value.trim();
            const description = document.getElementById('knotDescription').value.trim();
            const categoryId = document.getElementById('knotCategory').value;
            const difficultyLevel = document.getElementById('knotDifficulty').value;
            const isPublished = document.getElementById('knotPublished').checked;
            const coverFile = document.getElementById('knotCover').files[0];

            // 前端验证必填字段
            if (!name) {
                alert('请输入绳结名称');
                document.getElementById('knotName').focus();
                return;
            }

            if (!description) {
                alert('请输入绳结描述');
                document.getElementById('knotDescription').focus();
                return;
            }

            if (!categoryId) {
                alert('请选择分类');
                document.getElementById('knotCategory').focus();
                return;
            }

            // 封面图片必填验证
            if (!coverFile) {
                alert('请选择封面图片');
                document.getElementById('knotCover').focus();
                return;
            }

            // 创建FormData对象
            const formData = new FormData();
            formData.append('name', name);
            formData.append('description', description);
            formData.append('categoryId', categoryId);
            formData.append('difficultyLevel', difficultyLevel);
            formData.append('isPublished', isPublished);

            if (coverFile) {
                formData.append('coverImage', coverFile);
            }

            // 发送请求到后端
            fetch('/admin/api/knots', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('绳结添加成功！');
                    // 关闭模态框
                    const modal = bootstrap.Modal.getInstance(document.getElementById('addKnotModal'));
                    modal.hide();
                    // 重新加载列表
                    loadKnots(currentPage);
                } else {
                    alert('添加失败：' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('添加失败，请重试');
            });
        }

        // 编辑绳结
        function editKnot(id) {
            // 获取绳结详情
            fetch(`/admin/api/knots/${id}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const knot = data.data;
                        // 填充表单
                        document.getElementById('editKnotId').value = knot.id;
                        document.getElementById('editKnotName').value = knot.name;
                        document.getElementById('editKnotDescription').value = knot.description;
                        document.getElementById('editKnotCategory').value = knot.categoryId;
                        document.getElementById('editKnotDifficulty').value = knot.difficultyLevel;
                        document.getElementById('editKnotPublished').checked = knot.isPublished;

                        // 显示封面图片预览
                        if (knot.coverImage) {
                            document.getElementById('editCoverPreview').src = knot.coverImage;
                            document.getElementById('editCoverPreview').classList.remove('d-none');
                        } else {
                            document.getElementById('editCoverPreview').classList.add('d-none');
                        }

                        // 显示现有图片
                        displayExistingImages(knot.images || []);

                        // 清空动态图片容器
                        document.getElementById('knotImagesContainer').innerHTML = '';

                        // 显示编辑模态框
                        const modal = new bootstrap.Modal(document.getElementById('editKnotModal'));
                        modal.show();
                    } else {
                        alert('获取绳结详情失败：' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('获取绳结详情失败，请重试');
                });
        }

        // 显示现有图片
        function displayExistingImages(images) {
            const container = document.getElementById('existingImagesContainer');
            container.innerHTML = '';

            if (images.length === 0) {
                container.innerHTML = '<p class="text-muted">暂无图片</p>';
                return;
            }

            images.forEach(image => {
                const imageDiv = document.createElement('div');
                imageDiv.className = 'col-md-3 mb-3';
                imageDiv.innerHTML = `
                    <div class="card">
                        <img src="${image.imageUrl}" class="card-img-top" alt="绳结图片" style="height: 150px; object-fit: cover;">
                        <div class="card-body">
                            <div class="mb-2">
                                <label class="form-label">描述</label>
                                <input type="text" class="form-control form-control-sm" value="${image.imageRemark || ''}"
                                       onchange="updateImageRemark(${image.id}, this.value)">
                            </div>
                            <div class="mb-2">
                                <label class="form-label">排序</label>
                                <input type="number" class="form-control form-control-sm" value="${image.sortOrder || 0}"
                                       onchange="updateImageSortOrder(${image.id}, this.value)">
                            </div>
                            <button type="button" class="btn btn-sm btn-danger" onclick="deleteKnotImage(${image.id})">
                                <i class="bi bi-trash"></i> 删除
                            </button>
                        </div>
                    </div>
                `;
                container.appendChild(imageDiv);
            });
        }

        // 更新图片描述
        function updateImageRemark(imageId, remark) {
            fetch(`/admin/api/knot-images/${imageId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ imageRemark: remark })
            })
            .then(response => response.json())
            .then(data => {
                if (!data.success) {
                    alert('更新图片描述失败：' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('更新图片描述失败，请重试');
            });
        }

        // 更新图片排序
        function updateImageSortOrder(imageId, sortOrder) {
            fetch(`/admin/api/knot-images/${imageId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ sortOrder: parseInt(sortOrder) })
            })
            .then(response => response.json())
            .then(data => {
                if (!data.success) {
                    alert('更新图片排序失败：' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('更新图片排序失败，请重试');
            });
        }

        // 删除绳结图片
        function deleteKnotImage(imageId) {
            if (confirm('确定要删除这张图片吗？')) {
                fetch(`/admin/api/knot-images/${imageId}`, {
                    method: 'DELETE'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('图片删除成功！');
                        // 重新加载编辑模态框中的图片
                        const knotId = document.getElementById('editKnotId').value;
                        editKnot(knotId);
                    } else {
                        alert('删除失败：' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('删除失败，请重试');
                });
            }
        }

        // 更新绳结
        function updateKnot() {
            // 获取表单数据
            const id = document.getElementById('editKnotId').value;
            const name = document.getElementById('editKnotName').value.trim();
            const description = document.getElementById('editKnotDescription').value.trim();
            const categoryId = document.getElementById('editKnotCategory').value;
            const difficultyLevel = document.getElementById('editKnotDifficulty').value;
            const isPublished = document.getElementById('editKnotPublished').checked;
            const coverFile = document.getElementById('editKnotCover').files[0];

            // 获取动态添加的图片行数据
            const imageRows = document.getElementById('knotImagesContainer').children;
            const newImages = [];
            const newImageRemarks = [];
            const newImageSortOrders = [];

            // 前端验证必填字段
            if (!name) {
                alert('请输入绳结名称');
                document.getElementById('editKnotName').focus();
                return;
            }

            if (!description) {
                alert('请输入绳结描述');
                document.getElementById('editKnotDescription').focus();
                return;
            }

            if (!categoryId) {
                alert('请选择分类');
                document.getElementById('editKnotCategory').focus();
                return;
            }

            // 收集动态添加的图片数据
            for (let i = 0; i < imageRows.length; i++) {
                const row = imageRows[i];
                const fileInput = row.querySelector('input[type="file"]');
                const remarkInput = row.querySelector('input[type="text"]');

                if (fileInput && fileInput.files[0]) {
                    newImages.push(fileInput.files[0]);
                    newImageRemarks.push(remarkInput ? remarkInput.value.trim() : '');
                    newImageSortOrders.push(i + 1);
                }
            }

            // 创建FormData对象
            const formData = new FormData();
            formData.append('name', name);
            formData.append('description', description);
            formData.append('categoryId', categoryId);
            formData.append('difficultyLevel', difficultyLevel);
            formData.append('isPublished', isPublished);

            if (coverFile) {
                formData.append('coverImage', coverFile);
            }

            // 添加新图片
            if (newImages.length > 0) {
                for (let i = 0; i < newImages.length; i++) {
                    formData.append('images', newImages[i]);
                    formData.append('imageRemarks', newImageRemarks[i]);
                    formData.append('imageSortOrders', newImageSortOrders[i]);
                }
            }

            // 发送请求到后端
            fetch(`/admin/api/knots/${id}`, {
                method: 'PUT',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('绳结更新成功！');
                    // 关闭模态框
                    const modal = bootstrap.Modal.getInstance(document.getElementById('editKnotModal'));
                    modal.hide();
                    // 重新加载列表
                    loadKnots(currentPage);
                } else {
                    alert('更新失败：' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('更新失败，请重试');
            });
        }

        // 编辑封面图片预览
        document.getElementById('editKnotCover').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const preview = document.getElementById('editCoverPreview');
                    preview.src = e.target.result;
                    preview.classList.remove('d-none');
                };
                reader.readAsDataURL(file);
            }
        });

        // 动态添加绳结图片行
        function addKnotImageRow() {
            const container = document.getElementById('knotImagesContainer');
            const imageCount = container.children.length;
            const rowId = `imageRow_${Date.now()}`;

            const rowHtml = `
                <div class="row mb-3 align-items-center" id="${rowId}">
                    <div class="col-md-1">
                        <span class="badge bg-primary">${imageCount + 1}</span>
                    </div>
                    <div class="col-md-4">
                        <input type="file" class="form-control form-control-sm" accept="image/*"
                               onchange="previewKnotImage(this, '${rowId}')">
                    </div>
                    <div class="col-md-4">
                        <input type="text" class="form-control form-control-sm" placeholder="图片描述"
                               id="remark_${rowId}">
                    </div>
                    <div class="col-md-2">
                        <img id="preview_${rowId}" class="img-thumbnail d-none" style="max-width: 60px; max-height: 60px;">
                    </div>
                    <div class="col-md-1">
                        <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeKnotImageRow('${rowId}')">
                            <i class="bi bi-trash"></i>
                        </button>
                    </div>
                </div>
            `;

            container.insertAdjacentHTML('beforeend', rowHtml);
        }

        // 预览绳结图片
        function previewKnotImage(input, rowId) {
            const file = input.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const preview = document.getElementById(`preview_${rowId}`);
                    preview.src = e.target.result;
                    preview.classList.remove('d-none');
                };
                reader.readAsDataURL(file);
            }
        }

        // 删除绳结图片行
        function removeKnotImageRow(rowId) {
            const row = document.getElementById(rowId);
            if (row) {
                row.remove();
                // 重新排序
                reorderKnotImages();
            }
        }

        // 重新排序绳结图片
        function reorderKnotImages() {
            const container = document.getElementById('knotImagesContainer');
            const rows = container.children;

            for (let i = 0; i < rows.length; i++) {
                const badge = rows[i].querySelector('.badge');
                if (badge) {
                    badge.textContent = i + 1;
                }
            }
        }

        // 删除绳结
        function deleteKnot(id) {
            if (confirm('确定要删除这个绳结吗？')) {
                fetch(`/admin/api/knots/${id}`, {
                    method: 'DELETE'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('删除成功！');
                        // 重新加载列表
                        loadKnots(currentPage);
                    } else {
                        alert('删除失败：' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('删除失败，请重试');
                });
            }
        }

        // 登出功能
        async function handleLogout() {
            if (confirm('确定要退出登录吗？')) {
                try {
                    const response = await fetch('/admin/auth/logout', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        }
                    });

                    const result = await response.json();

                    if (result.success) {
                        // 登出成功，跳转到登录页面
                        window.location.href = '/admin/login';
                    } else {
                        alert('登出失败：' + result.message);
                    }
                } catch (error) {
                    console.error('Logout error:', error);
                    alert('登出失败，请稍后重试');
                }
            }
        }

        // 定期检查登录状态
        setInterval(async function() {
            try {
                const response = await fetch('/admin/auth/status');
                const result = await response.json();

                if (!result.loggedIn) {
                    // 如果未登录，跳转到登录页面
                    window.location.href = '/admin/login';
                }
            } catch (error) {
                console.error('Status check error:', error);
            }
        }, 60000); // 每分钟检查一次
    </script>
</body>
</html>
